{% extends 'admin_panel/base_admin.html' %}
{% load static %}
{% block title %}Certificate Approvals - Admin Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_panel/certificate_approvals.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Certificate Approvals</h1>
    <p>Review and approve certificate templates uploaded by NGOs</p>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <a href="?status=pending{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
       class="tab {% if status_filter == 'pending' or not status_filter %}active{% endif %}">
        Pending ({{ pending_count }})
    </a>
    <a href="?status=approved{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
       class="tab {% if status_filter == 'approved' %}active{% endif %}">
        Approved ({{ approved_count }})
    </a>
    <a href="?status=rejected{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
       class="tab {% if status_filter == 'rejected' %}active{% endif %}">
        Rejected ({{ rejected_count }})
    </a>
    <a href="?status=all{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" 
       class="tab {% if status_filter == 'all' %}active{% endif %}">
        All ({{ total_count }})
    </a>
</div>

<!-- Search and Sort Toolbar -->
<div class="admin-toolbar">
    <div class="search-box">
        <form method="get" action="">
            <input type="hidden" name="status" value="{{ status_filter }}">
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="text" name="search" placeholder="Search by event or NGO name..." value="{{ search_query }}" class="search-input">
            <button type="submit" class="btn-search">üîç Search</button>
        </form>
    </div>
    <div class="sort-box">
        <form method="get" action="">
            <input type="hidden" name="status" value="{{ status_filter }}">
            <input type="hidden" name="search" value="{{ search_query }}">
            <select name="sort" class="sort-select" onchange="this.form.submit()">
                <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
                <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Oldest First</option>
            </select>
        </form>
    </div>
</div>

<!-- Certificates List -->
<div class="certificates-container">
    {% if certificates %}
        {% for certificate in certificates %}
        <div class="certificate-card">
            <div class="certificate-card-header">
                <div class="certificate-info">
                    <div class="ngo-logo">
                        {% if certificate.event.ngo.logo %}
                            <img src="{{ certificate.event.ngo.logo.url }}" alt="{{ certificate.event.ngo.organization_name }}">
                        {% else %}
                            <div class="logo-placeholder">{{ certificate.event.ngo.organization_name|first|upper }}</div>
                        {% endif %}
                    </div>
                    <div class="certificate-details">
                        <h3>{{ certificate.event.title }}</h3>
                        <p class="certificate-ngo">{{ certificate.event.ngo.organization_name }}</p>
                        <p class="certificate-meta">
                            <span>üìÖ {{ certificate.event.date|date:"M d, Y" }}</span>
                            <span>üìç {{ certificate.event.location }}</span>
                        </p>
                    </div>
                </div>
                <div class="certificate-status">
                    <span class="status-badge status-{{ certificate.status }}">{{ certificate.get_status_display }}</span>
                </div>
            </div>

            <div class="certificate-card-body">
                <div class="certificate-upload-info">
                    <div class="info-item">
                        <strong>Uploaded:</strong> {{ certificate.uploaded_at|date:"M d, Y - h:i A" }}
                    </div>
                    {% if certificate.approved_at %}
                    <div class="info-item">
                        <strong>Approved:</strong> {{ certificate.approved_at|date:"M d, Y - h:i A" }}
                    </div>
                    {% endif %}
                    <div class="info-item">
                        <strong>Registered Volunteers:</strong> {{ certificate.event.registrations.count }}
                    </div>
                    <div class="info-item">
                        <strong>Certificates Assigned:</strong> {{ certificate.assignments.count }}
                    </div>
                </div>

                <div class="certificate-preview">
                    <h4>üìÑ Certificate File</h4>
                    <div class="preview-actions">
                        <a href="{{ certificate.certificate_file.url }}" target="_blank" class="btn-preview">
                            üëÅÔ∏è Preview PDF
                        </a>
                        <a href="{{ certificate.certificate_file.url }}" download class="btn-download">
                            ‚¨áÔ∏è Download
                        </a>
                    </div>
                </div>
            </div>

            <div class="certificate-card-actions">
                <a href="{% url 'view_ngo_profile' certificate.event.ngo.id %}" class="btn-action btn-info">
                    üè¢ View NGO
                </a>
                <a href="{% url 'admin_event_detail' certificate.event.id %}" class="btn-action btn-info">
                    üìã View Event
                </a>
                
                {% if certificate.status == 'pending' %}
                    <form method="post" action="{% url 'admin_approve_certificate_action' certificate.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-action btn-success" 
                                onclick="return confirm('Are you sure you want to approve this certificate for {{ certificate.event.title }}?')">
                            ‚úì Approve
                        </button>
                    </form>
                    <form method="post" action="{% url 'admin_reject_certificate_action' certificate.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-action btn-danger" 
                                onclick="return confirm('Are you sure you want to reject and delete this certificate? The NGO will need to upload a new one.')">
                            ‚úó Reject
                        </button>
                    </form>
                {% elif certificate.status == 'approved' %}
                    <form method="post" action="{% url 'admin_reject_certificate_action' certificate.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-action btn-warning" 
                                onclick="return confirm('Are you sure you want to revoke approval and delete this certificate?')">
                            Revoke Approval
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-data-message">
            <div class="no-data-icon">üìú</div>
            <h3>No Certificates Found</h3>
            {% if search_query %}
                <p>No certificates match your search for "{{ search_query }}"</p>
            {% else %}
                <p>There are no certificates with status: {{ status_filter|default:"pending" }}</p>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin_panel/certificate_approvals.js' %}"></script>
{% endblock %}